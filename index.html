<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>专专 专 - 驻住 爪 (专)</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Sortable.js for drag & drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --background-color: #f5f5f5;
      --text-color: #333;
    }

    /* Dark Mode Colors */
    [data-theme="dark"] {
      --primary-color: #0d6efd;
      --secondary-color: #adb5bd;
      --background-color: #212529;
      --text-color: #f8f9fa;
    }

    body {
      direction: rtl;
      font-family: 'Heebo', Arial, sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }

    .navbar-brand {
      margin: 0 auto;
    }

    /* Screen Transitions */
    .screen {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
    }

    .screen.active {
      opacity: 1;
      transform: translateY(0);
    }

    /* Drag & Drop Styles */
    .draggable-player {
      cursor: move;
      padding: 10px;
      margin: 5px 0;
      background: var(--secondary-color);
      border-radius: 4px;
      user-select: none;
    }

    .draggable-player.dragging {
      opacity: 0.5;
    }

    .team-container {
      min-height: 100px;
      border: 2px dashed var(--primary-color);
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .table-responsive {
        font-size: 0.9em;
      }
      
      .btn {
        width: 100%;
        margin: 5px 0;
      }
    }

    /* Additional UI Improvements */
    .card {
      background: var(--background-color);
      border: 1px solid var(--secondary-color);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .form-control {
      background: var(--background-color);
      color: var(--text-color);
      border-color: var(--secondary-color);
    }

    .form-control:focus {
      background: var(--background-color);
      color: var(--text-color);
    }
  </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <button 
      class="btn btn-danger" 
      id="endTournamentBtn"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      title="住 转 专专">
      住 专专
    </button>
    <span class="navbar-brand"> 专专 - 驻住 爪</span>
    <button 
      class="btn btn-warning" 
      id="installBtn"
      style="display: none;"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      title="转拽 驻拽爪">
      转拽 (PWA)
    </button>
  </div>
</nav>

<div class="container mt-3" id="appContainer">
  <!-- Screen 1: Tournament Configuration -->
  <div id="screenConfig" class="screen">
    <div class="card p-4">
      <h2>专转 专专</h2>
      <form id="configForm" class="needs-validation" novalidate>
        <div class="mb-3">
          <label class="form-label">住驻专 拽爪转:</label>
          <input 
            type="number" 
            class="form-control" 
            id="numTeamsInput" 
            min="2" 
            value="3"
            required>
          <div class="invalid-feedback">
              住驻专 拽爪转 转拽 ( 2)
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">住驻专 砖拽  拽爪:</label>
          <input 
            type="number" 
            class="form-control" 
            id="playersPerTeamInput" 
            min="1" 
            value="6"
            required>
          <div class="invalid-feedback">
              住驻专 砖拽 转拽 ( 1)
          </div>
        </div>
        <button type="submit" class="btn btn-primary">砖</button>
      </form>
    </div>
  </div>

  <!-- Screen 2: Player Names -->
  <div id="screenPlayers" class="screen d-none">
    <div class="card p-4">
      <h3> <span id="totalPlayersSpan">18</span> 砖转 砖拽</h3>
      <form id="playersForm" class="needs-validation" novalidate>
        <div class="mb-3">
          <textarea 
            id="playersInput" 
            rows="6" 
            class="form-control"
            placeholder="拽 砖转 砖拽, 驻专 驻住拽  砖专 砖"
            required></textarea>
          <div class="invalid-feedback">
              转  砖转 砖拽
          </div>
        </div>
        <button type="submit" class="btn btn-success">专 拽爪转</button>
      </form>
    </div>
  </div>

  <!-- Screen 3: Team Definition -->
  <div id="screenDefineTeams" class="screen d-none">
    <div class="card p-4">
      <h3>专转 拽爪转</h3>
      <div id="teamsDefinition"></div>
      <button class="btn btn-primary mt-3" id="teamsDefinitionDoneBtn">
        砖 拽转 砖拽
      </button>
    </div>
  </div>

  <!-- Screen 4: Player Assignment (Drag & Drop) -->
  <div id="screenAssign" class="screen d-none">
    <div class="card p-4">
      <h3>拽转 砖拽 拽爪转</h3>
      <div class="row" id="dragDropContainer">
        <!-- Unassigned Players -->
        <div class="col-md-4">
          <h5>砖拽  砖爪</h5>
          <div id="unassignedPlayers" class="team-container"></div>
        </div>
        <!-- Team Containers (will be populated dynamically) -->
        <div class="col-md-8" id="teamContainers"></div>
      </div>
      <button class="btn btn-primary mt-3" id="finishAssignBtn">住 拽</button>
    </div>
  </div>

  <!-- Additional screens (Tournament, End) remain similar but styled according to new design -->
  <!-- ... -->

</div>

<!-- Dark Mode Toggle -->
<button 
  class="btn btn-outline-primary dark-mode-toggle" 
  id="darkModeToggle"
  aria-label="Toggle Dark Mode">
  
</button>

<script>
// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const registration = await navigator.serviceWorker.register('/sw.js');
      console.log('ServiceWorker registered');
    } catch (error) {
      console.error('ServiceWorker registration failed:', error);
    }
  });
}

// PWA Installation
let deferredPrompt = null;
const installBtn = document.getElementById("installBtn");

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
});

installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    try {
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User ${outcome === 'accepted' ? 'accepted' : 'dismissed'} A2HS`);
    } catch (error) {
      console.error('A2HS error:', error);
    }
    deferredPrompt = null;
    installBtn.style.display = 'none';
  }
});

// Dark Mode Management
const darkModeToggle = document.getElementById('darkModeToggle');
const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

// Load saved theme from localStorage
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
}

darkModeToggle.addEventListener('click', () => {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
});

// Form Validation
function validateForm(formElement) {
  if (!formElement.checkValidity()) {
    formElement.classList.add('was-validated');
    return false;
  }
  return true;
}

// Screen Management with Animations
function showScreen(screenId) {
  const screens = document.querySelectorAll('.screen');
  screens.forEach(screen => {
    screen.classList.add('d-none');
    screen.classList.remove('active');
  });

  const targetScreen = document.getElementById(screenId);
  targetScreen.classList.remove('d-none');
  // Trigger reflow
  void targetScreen.offsetWidth;
  targetScreen.classList.add('active');
}

// Drag & Drop Implementation
function initializeDragAndDrop() {
  const containers = document.querySelectorAll('.team-container');
  containers.forEach(container => {
    new Sortable(container, {
      group: 'shared',
      animation: 150,
      ghostClass: 'dragging',
      onEnd: function(evt) {
        validateTeamSizes();
        saveCurrentState();
      }
    });
  });
}

// Local Storage Management
function saveCurrentState() {
  const state = {
    teams,
    players: playersPool,
    currentScreen: getCurrentScreen(),
    matches,
    scorers
  };
  localStorage.setItem('tournamentState', JSON.stringify(state));
}

function loadSavedState() {
  try {
    const savedState = localStorage.getItem('tournamentState');
    if (savedState) {
      const state = JSON.parse(savedState);
      teams = state.teams;
      playersPool = state.players;
      matches = state.matches;
      scorers = state.scorers;
      showScreen(state.currentScreen);
      return true;
    }
  } catch (error) {
    console.error('Error loading saved state:', error);
  }
  return false;
}

// Event Listeners and Initialization
document.addEventListener('DOMContentLoaded', () => {
  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(
    document.querySelectorAll('[data-bs-toggle="tooltip"]')
  );
  tooltipTriggerList.map(tooltipTriggerEl => {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Try to load saved state
  if (!loadSavedState()) {
    showScreen('screenConfig');
  }

  // Initialize forms validation
  initializeFormsValidation();
});

// Additional functionality (tournament management, statistics, etc.) remains similar
// but with added state management and responsive design considerations
// ...

</script>

</body>
</html>
