<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>טורניר כדורגל - המפסיד יוצא (מורחב)</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Sortable.js for drag & drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

  <style>
    :root {
      --primary-color: #007bff;
      --primary-color-rgb: 0, 123, 255;
      --secondary-color: #6c757d;
      --background-color: #f5f5f5;
      --text-color: #333;
      --card-bg: #ffffff;
    }

    [data-theme="dark"] {
      --primary-color: #0d6efd;
      --primary-color-rgb: 13, 110, 253;
      --secondary-color: #adb5bd;
      --background-color: #212529;
      --text-color: #f8f9fa;
      --card-bg: #2b3035;
    }

    body {
      direction: rtl;
      font-family: 'Heebo', Arial, sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .screen {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s ease-in-out;
      display: none;
    }

    .screen.active {
      opacity: 1;
      transform: translateY(0);
      display: block;
    }

    .team-container {
      min-height: 100px;
      border: 2px dashed var(--primary-color);
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background: rgba(var(--primary-color-rgb), 0.05);
    }

    .draggable-player {
      padding: 8px 12px;
      margin: 4px 0;
      background: var(--card-bg);
      border: 1px solid var(--secondary-color);
      border-radius: 4px;
      cursor: move;
      transition: all 0.2s ease;
    }

    .draggable-player:hover {
      background: var(--secondary-color);
      color: white;
    }

    .dark-mode-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .table-container {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .table th {
      background-color: var(--background-color);
      color: var(--text-color);
    }

    .table td {
      color: var(--text-color);
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .team-container {
        margin: 5px 0;
      }
      
      .btn {
        width: 100%;
        margin: 5px 0;
      }

      .table-responsive {
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <button class="btn btn-danger" id="endTournamentBtn">
      סיום טורניר
    </button>
    <span class="navbar-brand">ניהול טורניר - המפסיד יוצא</span>
    <button class="btn btn-warning" id="installBtn" style="display: none;">
      התקן (PWA)
    </button>
  </div>
</nav>

<div class="container mt-4">
  <!-- Screen 1: Tournament Configuration -->
  <div id="screenConfig" class="screen">
    <div class="card p-4">
      <h2 class="mb-4">הגדרת הטורניר</h2>
      <form id="configForm" class="needs-validation" novalidate>
        <div class="mb-3">
          <label class="form-label">מספר קבוצות:</label>
          <input type="number" class="form-control" id="numTeamsInput" 
                 min="2" value="3" required>
          <div class="invalid-feedback">
            נא להזין מספר קבוצות תקין (מינימום 2)
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">מספר שחקנים בכל קבוצה:</label>
          <input type="number" class="form-control" id="playersPerTeamInput"
                 min="1" value="6" required>
          <div class="invalid-feedback">
            נא להזין מספר שחקנים תקין (מינימום 1)
          </div>
        </div>
        <button type="submit" class="btn btn-primary">המשך</button>
      </form>
    </div>
  </div>

  <!-- Screen 2: Player Names -->
  <div id="screenPlayers" class="screen">
    <div class="card p-4">
      <h3 class="mb-4">הזן <span id="totalPlayersSpan">18</span> שמות שחקנים</h3>
      <form id="playersForm" class="needs-validation" novalidate>
        <div class="mb-3">
          <textarea id="playersInput" rows="6" class="form-control"
                    placeholder="הקלד שמות שחקנים, מופרדים בפסיק או שורה חדשה"
                    required></textarea>
          <div class="invalid-feedback">
            נא להזין את כל שמות השחקנים
          </div>
        </div>
        <button type="submit" class="btn btn-success">הגדר קבוצות</button>
      </form>
    </div>
  </div>

  <!-- Screen 3: Team Definition -->
  <div id="screenDefineTeams" class="screen">
    <div class="card p-4">
      <h3 class="mb-4">הגדרת הקבוצות</h3>
      <div id="teamsDefinition"></div>
      <button class="btn btn-primary mt-3" id="teamsDefinitionDoneBtn">
        המשך לחלוקת שחקנים
      </button>
    </div>
  </div>

  <!-- Screen 4: Player Assignment -->
  <div id="screenAssign" class="screen">
    <div class="card p-4">
      <h3 class="mb-4">חלוקת שחקנים לקבוצות</h3>
      <div class="row">
        <div class="col-md-4">
          <h5>שחקנים לא משובצים</h5>
          <div id="unassignedPlayers" class="team-container"></div>
        </div>
        <div class="col-md-8" id="teamContainers"></div>
      </div>
      <button class="btn btn-primary mt-3" id="finishAssignBtn">
        סיום החלוקה
      </button>
    </div>
  </div>

  <!-- Screen 5: Tournament Management -->
  <div id="screenTournament" class="screen">
    <div class="card p-4">
      <h3 class="mb-4">ניהול הטורניר</h3>
      
      <!-- Teams Table -->
      <div class="table-container">
        <h5>טבלת הקבוצות</h5>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>קבוצה</th>
                <th>צבע</th>
                <th>נצ'</th>
                <th>תיקו</th>
                <th>הפ'</th>
                <th>שע' בעד</th>
                <th>שע' נגד</th>
                <th>הפרש</th>
                <th>נק'</th>
                <th>דירוג</th>
              </tr>
            </thead>
            <tbody id="teamsTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Current Match -->
      <div class="card mb-4">
        <div class="card-body">
          <h5 id="currentMatchTitle" class="card-title mb-3">משחק נוכחי</h5>
          <div class="row" id="currentMatchTeams"></div>
          <div class="text-center mt-3">
            <button class="btn btn-success" id="submitMatchBtn">סיים משחק</button>
          </div>
        </div>
      </div>

      <!-- Top Scorers -->
      <div class="table-container">
        <h5>מלך השערים</h5>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>שחקן</th>
                <th>קבוצה</th>
                <th>שערים</th>
              </tr>
            </thead>
            <tbody id="scorersTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Match History -->
      <div class="table-container">
        <h5>היסטוריית משחקים</h5>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>#</th>
                <th>קבוצות</th>
                <th>תוצאה</th>
                <th>מנצחת</th>
              </tr>
            </thead>
            <tbody id="matchesTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Goals Chart -->
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">גרף שערים</h5>
          <canvas id="goalsChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dark Mode Toggle -->
<button class="btn btn-outline-primary dark-mode-toggle" id="darkModeToggle">
  🌓
</button>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Global Variables
let numTeams = 3;
let playersPerTeam = 6;
let totalPlayers = numTeams * playersPerTeam;
let playersPool = [];
let teams = [];
let activeTeams = [];
let waitingTeams = [];
let matches = [];
let scorers = {};
let goalsChart = null;

// Form Validation
function validateForm(form) {
  if (!form.checkValidity()) {
    form.classList.add('was-validated');
    return false;
  }
  return true;
}

// Screen Management
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.classList.remove('active');
  });
  
  const targetScreen = document.getElementById(screenId);
  targetScreen.classList.add('active');
}

// Dark Mode Management
const darkModeToggle = document.getElementById('darkModeToggle');

function initializeDarkMode() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  darkModeToggle.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  });
}

// Teams Management
function setupTeamsArray() {
  teams = [];
  for (let i = 0; i < numTeams; i++) {
    teams.push({
      name: `קבוצה ${i+1}`,
      color: getRandomColor(),
      players: [],
      w: 0, d: 0, l: 0,
      gf: 0, ga: 0, gd: 0,
      points: 0
    });
  }
}

function getRandomColor() {
  const letters = '0123456789ABCDEF';
  let color = '#';
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

function renderTeamsDefinition() {
  const container = document.getElementById('teamsDefinition');
  container.innerHTML = '';
  
  teams.forEach((team, idx) => {
    const teamDiv = document.createElement('div');
    teamDiv.className = 'mb-3 p-3 border rounded';
    teamDiv.innerHTML = `
      <div class="mb-2">
        <label class="form-label">שם קבוצה ${idx + 1}:</label>
        <input type="text" class="form-control" value="${team.name}">
      </div>
      <div>
        <label class="form-label">צבע קבוצה:</label>
        <input type="color" class="form-control form-control-color" value="${team.color}">
      </div>
    `;

    const nameInput = teamDiv.querySelector('input[type="text"]');
    const colorInput = teamDiv.querySelector('input[type="color"]');

    nameInput.addEventListener('change', () => {
      teams[idx].name = nameInput.value || `קבוצה ${idx + 1}`;
    });

    colorInput.addEventListener('change', () => {
      teams[idx].color = colorInput.value;
    });

    container.appendChild(teamDiv);
  });
}

// Tournament Management
function prepareTournament() {
  // Reset tournament state
  matches = [];
  scorers = {};
  
  // Initialize active teams (first two teams)
  activeTeams = [0, 1];
  
  // Rest of teams go to waiting list
  waitingTeams = [];
  for (let i = 2; i < teams.length; i++) {
    waitingTeams.push(i);
  }

  // Initialize statistics
  teams.forEach(team => {
    team.w = 0;
    team.d = 0;
    team.l = 0;
    team.gf = 0;
    team.ga = 0;
    team.gd = 0;
    team.points = 0;
  });

  // Initialize chart
  initializeGoalsChart();
  
  // Render initial state
  updateTeamsTable();
  updateScorersTable();
  renderCurrentMatch();
}

function initializeGoalsChart() {
  const ctx = document.getElementById('goalsChart').getContext('2d');
  goalsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'שערים למשחק',
        data: [],
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

function updateTeamsTable() {
  const tbody = document.getElementById('teamsTableBody');
  tbody.innerHTML = '';

  // Sort teams by points, then goal difference
  const sortedTeams = teams.map((team, idx) => ({...team, originalIndex: idx}))
    .sort((a, b) => {
      if (b.points !== a.points) return b.points - a.points;
      if (b.gd !== a.gd) return b.gd - a.gd;
      return b.gf - a.gf;
    });

  sortedTeams.forEach((team, rank) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${team.name}</td>
      <td>
        <span style="display:inline-block;width:20px;height:20px;background:${team.color};border-radius:50%"></span>
      </td>
      <td>${team.w}</td>
      <td>${team.d}</td>
      <td>${team.l}</td>
      <td>${team.gf}</td>
      <td>${team.ga}</td>
      <td>${team.gd}</td>
      <td>${team.points}</td>
      <td>${rank + 1}</td>
    `;
    tbody.appendChild(row);
  });
}

function updateScorersTable() {
  const tbody = document.getElementById('scorersTableBody');
  tbody.innerHTML = '';

  // Sort scorers by goals
  const sortedScorers = Object.entries(scorers)
    .map(([name, data]) => ({name, ...data}))
    .sort((a, b) => b.goals - a.goals);

  sortedScorers.forEach(scorer => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${scorer.name}</td>
      <td>${scorer.team}</td>
      <td>${scorer.goals}</td>
    `;
    tbody.appendChild(row);
  });
}
  function finishCurrentMatch() {
  const teamAGoals = Array.from(document.querySelectorAll('#teamAPlayers [data-player]'))
    .reduce((sum, span) => sum + (parseInt(span.textContent) || 0), 0);
    
  const teamBGoals = Array.from(document.querySelectorAll('#teamBPlayers [data-player]'))
    .reduce((sum, span) => sum + (parseInt(span.textContent) || 0), 0);

  // Update team statistics
  const teamA = teams[activeTeams[0]];
  const teamB = teams[activeTeams[1]];

  teamA.gf += teamAGoals;
  teamA.ga += teamBGoals;
  teamB.gf += teamBGoals;
  teamB.ga += teamAGoals;

  if (teamAGoals > teamBGoals) {
    teamA.w++; teamA.points += 3;
    teamB.l++;
    handleMatchEnd(activeTeams[0], activeTeams[1]);
  } else if (teamBGoals > teamAGoals) {
    teamB.w++; teamB.points += 3;
    teamA.l++;
    handleMatchEnd(activeTeams[1], activeTeams[0]);
  } else {
    teamA.d++; teamA.points++;
    teamB.d++; teamB.points++;
    // Handle tie with prompt
    const tieWinner = confirm(`תיקו! האם ${teamA.name} מנצחת בהגרלה?`) ? 
      activeTeams[0] : activeTeams[1];
    handleMatchEnd(tieWinner, tieWinner === activeTeams[0] ? activeTeams[1] : activeTeams[0]);
  }

  // Update goal differences
  teamA.gd = teamA.gf - teamA.ga;
  teamB.gd = teamB.gf - teamB.ga;

  // Update scorers
  document.querySelectorAll('[data-player]').forEach(span => {
    const goals = parseInt(span.textContent) || 0;
    if (goals > 0) {
      const playerName = span.dataset.player;
      const teamName = span.closest('#teamAPlayers') ? teamA.name : teamB.name;
      
      if (!scorers[playerName]) {
        scorers[playerName] = { goals: 0, team: teamName };
      }
      scorers[playerName].goals += goals;
    }
  });

  // Update chart
  if (goalsChart) {
    goalsChart.data.labels.push(`משחק ${matches.length + 1}`);
    goalsChart.data.datasets[0].data.push(teamAGoals + teamBGoals);
    goalsChart.update();
  }

  // Save state and update UI
  saveCurrentState();
  updateTeamsTable();
  updateScorersTable();
  renderCurrentMatch();
}

function handleMatchEnd(winnerIdx, loserIdx) {
  matches.push({
    matchNumber: matches.length + 1,
    teamA: activeTeams[0],
    teamB: activeTeams[1],
    winner: winnerIdx
  });

  // Move loser to waiting if there are waiting teams
  if (waitingTeams.length > 0) {
    const nextTeam = waitingTeams.shift();
    const loserActiveIndex = activeTeams.indexOf(loserIdx);
    activeTeams[loserActiveIndex] = nextTeam;
    waitingTeams.push(loserIdx);
  } else {
    // Remove loser if no waiting teams
    activeTeams = activeTeams.filter(idx => idx !== loserIdx);
  }
}

function renderCurrentMatch() {
  const container = document.getElementById('currentMatchTeams');
  const title = document.getElementById('currentMatchTitle');
  
  if (activeTeams.length < 2) {
    title.textContent = 'הטורניר הסתיים!';
    container.innerHTML = '<div class="col text-center">כל המשחקים הסתיימו</div>';
    document.getElementById('submitMatchBtn').disabled = true;
    return;
  }

  const teamA = teams[activeTeams[0]];
  const teamB = teams[activeTeams[1]];
  title.textContent = `${teamA.name} נגד ${teamB.name}`;

  container.innerHTML = `
    <div class="col-md-6">
      <h6>${teamA.name}</h6>
      <div id="teamAPlayers"></div>
    </div>
    <div class="col-md-6">
      <h6>${teamB.name}</h6>
      <div id="teamBPlayers"></div>
    </div>
  `;

  // Render player score controls
  ['A', 'B'].forEach((team, idx) => {
    const teamContainer = document.getElementById(`team${team}Players`);
    teams[activeTeams[idx]].players.forEach(player => {
      const playerDiv = document.createElement('div');
      playerDiv.className = 'draggable-player';
      playerDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span>${player}</span>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" onclick="updatePlayerScore('${player}', -1)">-</button>
            <span class="btn btn-sm" data-player="${player}">0</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="updatePlayerScore('${player}', 1)">+</button>
          </div>
        </div>
      `;
      teamContainer.appendChild(playerDiv);
    });
  });

  document.getElementById('submitMatchBtn').disabled = false;
}

function updatePlayerScore(playerName, change) {
  const scoreSpan = document.querySelector(`[data-player="${playerName}"]`);
  let currentScore = parseInt(scoreSpan.textContent) || 0;
  currentScore = Math.max(0, currentScore + change);
  scoreSpan.textContent = currentScore;
}

// Initialize Event Listeners
function initializeEventListeners() {
  // Config Form
  document.getElementById('configForm').addEventListener('submit', (e) => {
    e.preventDefault();
    if (validateForm(e.target)) {
      numTeams = parseInt(document.getElementById('numTeamsInput').value);
      playersPerTeam = parseInt(document.getElementById('playersPerTeamInput').value);
      totalPlayers = numTeams * playersPerTeam;
      document.getElementById('totalPlayersSpan').textContent = totalPlayers;
      showScreen('screenPlayers');
    }
  });

  // Players Form
  document.getElementById('playersForm').addEventListener('submit', (e) => {
    e.preventDefault();
    if (validateForm(e.target)) {
      const rawText = document.getElementById('playersInput').value.trim();
      const names = rawText.split(/[\n,]+/).map(s => s.trim()).filter(s => s);
      
      if (names.length === totalPlayers) {
        playersPool = names;
        setupTeamsArray();
        renderTeamsDefinition();
        showScreen('screenDefineTeams');
      } else {
        alert(`נא להזין בדיוק ${totalPlayers} שמות!`);
      }
    }
  });

  // Teams Definition Done Button
  document.getElementById('teamsDefinitionDoneBtn').addEventListener('click', () => {
    initializeDragAndDrop();
    renderPlayerAssignment();
    showScreen('screenAssign');
  });

  // Finish Assignment Button
  document.getElementById('finishAssignBtn').addEventListener('click', () => {
    if (validateTeamSizes()) {
      prepareTournament();
      showScreen('screenTournament');
    } else {
      alert(`כל קבוצה חייבת להכיל בדיוק ${playersPerTeam} שחקנים!`);
    }
  });

  // Submit Match Button
  document.getElementById('submitMatchBtn').addEventListener('click', finishCurrentMatch);

  // End Tournament Button
  document.getElementById('endTournamentBtn').addEventListener('click', () => {
    if (confirm('האם אתה בטוח שברצונך לסיים את הטורניר?')) {
      localStorage.removeItem('tournamentState');
      location.reload();
    }
  });
}

// Drag & Drop
function initializeDragAndDrop() {
  const containers = document.querySelectorAll('.team-container');
  containers.forEach(container => {
    new Sortable(container, {
      group: 'shared',
      animation: 150,
      ghostClass: 'sortable-ghost',
      onEnd: validateTeamSizes
    });
  });
}

function renderPlayerAssignment() {
  const unassignedContainer = document.getElementById('unassignedPlayers');
  const teamContainers = document.getElementById('teamContainers');
  
  // Clear containers
  unassignedContainer.innerHTML = '';
  teamContainers.innerHTML = '';
  
  // Add unassigned players
  playersPool.forEach(player => {
    const playerDiv = document.createElement('div');
    playerDiv.className = 'draggable-player';
    playerDiv.textContent = player;
    unassignedContainer.appendChild(playerDiv);
  });
  
  // Create team containers
  teams.forEach((team, idx) => {
    const teamDiv = document.createElement('div');
    teamDiv.className = 'mb-3';
    teamDiv.innerHTML = `
      <h5>${team.name}</h5>
      <div id="team-${idx}" class="team-container"></div>
    `;
    teamContainers.appendChild(teamDiv);
  });
}

function validateTeamSizes() {
  const teamContainers = document.querySelectorAll('#teamContainers .team-container');
  let isValid = true;
  
  teams.forEach((team, idx) => {
    const container = document.getElementById(`team-${idx}`);
    const players = container.querySelectorAll('.draggable-player');
    team.players = Array.from(players).map(p => p.textContent);
    
    if (players.length !== playersPerTeam) {
      isValid = false;
    }
  });
  
  document.getElementById('finishAssignBtn').disabled = !isValid;
  return isValid;
}

// State Management
function saveCurrentState() {
  const state = {
    numTeams,
    playersPerTeam,
    totalPlayers,
    playersPool,
    teams,
    matches,
    scorers
  };
  localStorage.setItem('tournamentState', JSON.stringify(state));
}

function loadSavedState() {
  try {
    const savedState = localStorage.getItem('tournamentState');
    if (savedState) {
      const state = JSON.parse(savedState);
      numTeams = state.numTeams;
      playersPerTeam = state.playersPerTeam;
      totalPlayers = state.totalPlayers;
      playersPool = state.playersPool;
      teams = state.teams;
      matches = state.matches;
      scorers = state.scorers;
      return true;
    }
  } catch (error) {
    console.error('Error loading saved state:', error);
  }
  return false;
}

// Initialize Application
document.addEventListener('DOMContentLoaded', () => {
  initializeDarkMode();
  initializeEventListeners();
  
  if (!loadSavedState()) {
    showScreen('screenConfig');
  }
});
</script>

</body>
</html>
