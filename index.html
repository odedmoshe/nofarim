<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>טורניר כדורגל - המפסיד יוצא (מורחב)</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Sortable.js for drag & drop -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #6c757d;
      --background-color: #f5f5f5;
      --text-color: #333;
      --card-bg: #ffffff;
    }

    [data-theme="dark"] {
      --primary-color: #0d6efd;
      --secondary-color: #adb5bd;
      --background-color: #212529;
      --text-color: #f8f9fa;
      --card-bg: #2b3035;
    }

    body {
      direction: rtl;
      font-family: 'Heebo', Arial, sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .card {
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .screen {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s ease-in-out;
      display: none;
    }

    .screen.active {
      opacity: 1;
      transform: translateY(0);
      display: block;
    }

    .team-container {
      min-height: 100px;
      border: 2px dashed var(--primary-color);
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background: rgba(var(--primary-color-rgb), 0.05);
    }

    .draggable-player {
      padding: 8px 12px;
      margin: 4px 0;
      background: var(--card-bg);
      border: 1px solid var(--secondary-color);
      border-radius: 4px;
      cursor: move;
      transition: all 0.2s ease;
    }

    .draggable-player:hover {
      background: var(--secondary-color);
      color: white;
    }

    .dark-mode-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      padding: 10px;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .team-container {
        margin: 5px 0;
      }
      
      .btn {
        width: 100%;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <button class="btn btn-danger" id="endTournamentBtn">
      סיום טורניר
    </button>
    <span class="navbar-brand">ניהול טורניר - המפסיד יוצא</span>
    <button class="btn btn-warning" id="installBtn" style="display: none;">
      התקן (PWA)
    </button>
  </div>
</nav>

<div class="container mt-4">
  <!-- Screen 1: Tournament Configuration -->
  <div id="screenConfig" class="screen">
    <div class="card p-4">
      <h2 class="mb-4">הגדרת הטורניר</h2>
      <form id="configForm" class="needs-validation" novalidate>
        <div class="mb-3">
          <label class="form-label">מספר קבוצות:</label>
          <input type="number" class="form-control" id="numTeamsInput" 
                 min="2" value="3" required>
          <div class="invalid-feedback">
            נא להזין מספר קבוצות תקין (מינימום 2)
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">מספר שחקנים בכל קבוצה:</label>
          <input type="number" class="form-control" id="playersPerTeamInput"
                 min="1" value="6" required>
          <div class="invalid-feedback">
            נא להזין מספר שחקנים תקין (מינימום 1)
          </div>
        </div>
        <button type="submit" class="btn btn-primary">המשך</button>
      </form>
    </div>
  </div>

  <!-- Screen 2: Player Names -->
  <div id="screenPlayers" class="screen">
    <div class="card p-4">
      <h3 class="mb-4">הזן <span id="totalPlayersSpan">18</span> שמות שחקנים</h3>
      <form id="playersForm" class="needs-validation" novalidate>
        <div class="mb-3">
          <textarea id="playersInput" rows="6" class="form-control"
                    placeholder="הקלד שמות שחקנים, מופרדים בפסיק או שורה חדשה"
                    required></textarea>
          <div class="invalid-feedback">
            נא להזין את כל שמות השחקנים
          </div>
        </div>
        <button type="submit" class="btn btn-success">הגדר קבוצות</button>
      </form>
    </div>
  </div>

  <!-- Screen 3: Team Definition -->
  <div id="screenDefineTeams" class="screen">
    <div class="card p-4">
      <h3 class="mb-4">הגדרת הקבוצות</h3>
      <div id="teamsDefinition"></div>
      <button class="btn btn-primary mt-3" id="teamsDefinitionDoneBtn">
        המשך לחלוקת שחקנים
      </button>
    </div>
  </div>

  <!-- Screen 4: Player Assignment -->
  <div id="screenAssign" class="screen">
    <div class="card p-4">
      <h3 class="mb-4">חלוקת שחקנים לקבוצות</h3>
      <div class="row">
        <div class="col-md-4">
          <h5>שחקנים לא משובצים</h5>
          <div id="unassignedPlayers" class="team-container"></div>
        </div>
        <div class="col-md-8" id="teamContainers"></div>
      </div>
      <button class="btn btn-primary mt-3" id="finishAssignBtn">
        סיום החלוקה
      </button>
    </div>
  </div>
</div>

<!-- Dark Mode Toggle -->
<button class="btn btn-outline-primary dark-mode-toggle" id="darkModeToggle">
  🌓
</button>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Global Variables
let numTeams = 3;
let playersPerTeam = 6;
let totalPlayers = numTeams * playersPerTeam;
let playersPool = [];
let teams = [];
let activeTeams = [];
let waitingTeams = [];
let matches = [];
let scorers = {};

// Form Validation
function validateForm(form) {
  if (!form.checkValidity()) {
    form.classList.add('was-validated');
    return false;
  }
  return true;
}

// Screen Management
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(screen => {
    screen.classList.remove('active');
  });
  
  const targetScreen = document.getElementById(screenId);
  targetScreen.classList.add('active');
}

// Dark Mode Management
const darkModeToggle = document.getElementById('darkModeToggle');

function initializeDarkMode() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  darkModeToggle.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  });
}

// Teams Management
function setupTeamsArray() {
  teams = [];
  for (let i = 0; i < numTeams; i++) {
    teams.push({
      name: `קבוצה ${i+1}`,
      color: getRandomColor(),
      players: [],
      w: 0, d: 0, l: 0,
      gf: 0, ga: 0, gd: 0,
      points: 0
    });
  }
}

function getRandomColor() {
  const letters = '0123456789ABCDEF';
  let color = '#';
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

function renderTeamsDefinition() {
  const container = document.getElementById('teamsDefinition');
  container.innerHTML = '';
  
  teams.forEach((team, idx) => {
    const teamDiv = document.createElement('div');
    teamDiv.className = 'mb-3 p-3 border rounded';
    teamDiv.innerHTML = `
      <div class="mb-2">
        <label class="form-label">שם קבוצה ${idx + 1}:</label>
        <input type="text" class="form-control" value="${team.name}">
      </div>
      <div>
        <label class="form-label">צבע קבוצה:</label>
        <input type="color" class="form-control form-control-color" value="${team.color}">
      </div>
    `;

    const nameInput = teamDiv.querySelector('input[type="text"]');
    const colorInput = teamDiv.querySelector('input[type="color"]');

    nameInput.addEventListener('change', () => {
      teams[idx].name = nameInput.value || `קבוצה ${idx + 1}`;
    });

    colorInput.addEventListener('change', () => {
      teams[idx].color = colorInput.value;
    });

    container.appendChild(teamDiv);
  });
}

// Initialize Event Listeners
function initializeEventListeners() {
  // Config Form
  document.getElementById('configForm').addEventListener('submit', (e) => {
    e.preventDefault();
    if (validateForm(e.target)) {
      numTeams = parseInt(document.getElementById('numTeamsInput').value);
      playersPerTeam = parseInt(document.getElementById('playersPerTeamInput').value);
      totalPlayers = numTeams * playersPerTeam;
      document.getElementById('totalPlayersSpan').textContent = totalPlayers;
      showScreen('screenPlayers');
    }
  });

  // Players Form
  document.getElementById('playersForm').addEventListener('submit', (e) => {
    e.preventDefault();
    if (validateForm(e.target)) {
      const rawText = document.getElementById('playersInput').value.trim();
      const names = rawText.split(/[\n,]+/).map(s => s.trim()).filter(s => s);
      
      if (names.length === totalPlayers) {
        playersPool = names;
        setupTeamsArray();
        renderTeamsDefinition();
        showScreen('screenDefineTeams');
      } else {
        alert(`נא להזין בדיוק ${totalPlayers} שמות!`);
      }
    }
  });

  // Teams Definition Done Button
  document.getElementById('teamsDefinitionDoneBtn').addEventListener('click', () => {
    initializeDragAndDrop();
    renderPlayerAssignment();
    showScreen('screenAssign');
  });

  // Finish Assignment Button
  document.getElementById('finishAssignBtn').addEventListener('click', validateAndStartTournament);
}

// Drag & Drop
function initializeDragAndDrop() {
  const containers = document.querySelectorAll('.team-container');
  containers.forEach(container => {
    new Sortable(container, {
      group: 'shared',
      animation: 150,
      ghostClass: 'sortable-ghost',
      onEnd: validateTeamSizes
    });
  });
}

function renderPlayerAssignment() {
  const unassignedContainer = document.getElementById('unassignedPlayers');
  const teamContainers = document.getElementById('teamContainers');
  
  // Clear containers
  unassignedContainer.innerHTML = '';
  teamContainers.innerHTML = '';
  
  // Add unassigned players
  playersPool.forEach(player => {
    const playerDiv = document.createElement('div');
    playerDiv.className = 'draggable-player';
    playerDiv.textContent = player;
    unassignedContainer.appendChild(playerDiv);
  });
  
  // Create team containers
  teams.forEach((team, idx) => {
    const teamDiv = document.createElement('div');
    teamDiv.className = 'mb-3';
    teamDiv.innerHTML = `
      <h
      <h5>${team.name}</h5>
      <div id="team-${idx}" class="team-container"></div>
    `;
    teamContainers.appendChild(teamDiv);
  });
}

function validateTeamSizes() {
  const teamContainers = document.querySelectorAll('#teamContainers .team-container');
  let isValid = true;
  
  teams.forEach((team, idx) => {
    const container = document.getElementById(`team-${idx}`);
    const players = container.querySelectorAll('.draggable-player');
    team.players = Array.from(players).map(p => p.textContent);
    
    if (players.length !== playersPerTeam) {
      isValid = false;
    }
  });
  
  document.getElementById('finishAssignBtn').disabled = !isValid;
  return isValid;
}

function validateAndStartTournament() {
  if (validateTeamSizes()) {
    saveCurrentState();
    prepareTournament();
    showScreen('screenTournament');
  } else {
    alert(`כל קבוצה חייבת להכיל בדיוק ${playersPerTeam} שחקנים!`);
  }
}

// State Management
function saveCurrentState() {
  const state = {
    numTeams,
    playersPerTeam,
    totalPlayers,
    playersPool,
    teams,
    matches,
    scorers
  };
  localStorage.setItem('tournamentState', JSON.stringify(state));
}

function loadSavedState() {
  try {
    const savedState = localStorage.getItem('tournamentState');
    if (savedState) {
      const state = JSON.parse(savedState);
      numTeams = state.numTeams;
      playersPerTeam = state.playersPerTeam;
      totalPlayers = state.totalPlayers;
      playersPool = state.playersPool;
      teams = state.teams;
      matches = state.matches;
      scorers = state.scorers;
      return true;
    }
  } catch (error) {
    console.error('Error loading saved state:', error);
  }
  return false;
}

// PWA Installation
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
});

installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    try {
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User ${outcome === 'accepted' ? 'accepted' : 'dismissed'} A2HS`);
    } catch (error) {
      console.error('A2HS error:', error);
    }
    deferredPrompt = null;
    installBtn.style.display = 'none';
  }
});

// Initialize Application
document.addEventListener('DOMContentLoaded', () => {
  initializeDarkMode();
  initializeEventListeners();
  
  if (!loadSavedState()) {
    showScreen('screenConfig');
  }
});
</script>

</body>
</html>
