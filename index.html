<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>טורניר כדורגל - המפסיד יוצא (מורחב)</title>

  <!-- אייקון / מניפסט ל-PWA -->
  <link rel="icon" href="icons/icon-192.png" type="image/png">
  <link rel="manifest" href="manifest.json">

  <!-- פונט מגוגל -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link 
    href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" 
    rel="stylesheet"
  >

  <!-- Bootstrap CSS -->
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  >

  <!-- Chart.js -->
  <script 
    src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js">
  </script>

  <style>
    body {
      direction: rtl;
      font-family: 'Heebo', Arial, sans-serif;
      background: #f5f5f5;
    }
    .navbar-brand {
      margin: 0 auto;
    }
    .hidden {
      display: none;
    }
    .fade-in {
      animation: fadeIn 0.4s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    [data-bs-toggle="tooltip"] {
      cursor: pointer;
    }
    .player-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fafafa;
      padding: 6px 8px;
      margin: 3px 0;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    .player-controls button {
      margin-left: 4px;
    }
    .table th, .table td {
      vertical-align: middle;
    }
    #installBtn {
      display: none;
    }
    /* כפתור רישום ל‑PWA */
    #installBtn.btn {
      position: absolute;
      right: 80px;
      top: 10px;
    }
  </style>
</head>
<body class="bg-light">

<!-- סרגל עליון: כפתור "סיום טורניר", כפתור התקנת PWA -->
<nav class="navbar navbar-dark bg-primary">
  <div class="container-fluid">
    <button 
      class="btn btn-danger" 
      id="endTournamentBtn"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      title="סיים את הטורניר ועבור למסך הסיום">
      סיום טורניר
    </button>
    <span class="navbar-brand">ניהול טורניר - המפסיד יוצא</span>
    <button 
      class="btn btn-warning" 
      id="installBtn"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      title="התקן כאפליקציה על המכשיר שלך">
      התקן (PWA)
    </button>
  </div>
</nav>

<div class="container mt-3 fade-in" id="appContainer">
  <!-- מסך ראשון: הגדרת טורניר - (כמה קבוצות, כמה שחקנים בקבוצה) -->
  <div id="screenConfig" class="fade-in">
    <h2>הגדרת הטורניר</h2>
    <div class="mb-3">
      <label>מספר קבוצות:</label>
      <input type="number" class="form-control" id="numTeamsInput" min="2" value="3">
    </div>
    <div class="mb-3">
      <label>מספר שחקנים בכל קבוצה:</label>
      <input type="number" class="form-control" id="playersPerTeamInput" min="1" value="6">
    </div>
    <button class="btn btn-primary" id="startSetupBtn">המשך</button>
  </div>

  <!-- מסך שני: הזנת שמות שחקנים (סה"כ numTeams * playersPerTeam) -->
  <div id="screenPlayers" class="hidden fade-in">
    <h3>הזן <span id="totalPlayersSpan">18</span> שמות שחקנים</h3>
    <textarea 
      id="playersInput" 
      rows="6" 
      class="form-control mb-3"
      placeholder="הקלד כאן את השמות... (מופרדים בפסיק או בשורות)">
    </textarea>
    <button class="btn btn-success" id="goToDefineTeamsBtn">הגדר קבוצות</button>
  </div>

  <!-- מסך שלישי: הגדרת שמות וצבעים של הקבוצות (אופציה לברירת מחדל) -->
  <div id="screenDefineTeams" class="hidden fade-in">
    <h3>הגדרת הקבוצות</h3>
    <div id="teamsDefinition"></div>
    <button class="btn btn-secondary" id="teamsDefinitionDoneBtn">
      המשך לחלוקת שחקנים
    </button>
  </div>

  <!-- מסך רביעי: חלוקת השחקנים לקבוצות (בודק שאין שחקן לא מוקצה, ושבכל קבוצה יש playersPerTeam) -->
  <div id="screenAssign" class="hidden fade-in">
    <h3>חלוקת שחקנים לקבוצות</h3>
    <div id="playersAssignContainer" class="mb-3"></div>
    <button class="btn btn-primary" id="finishAssignBtn">סיום החלוקה</button>
  </div>

  <!-- מסך חמישי: ניהול טורניר (2 קבוצות פעילות, השאר ממתינות, המפסידה יוצאת) -->
  <div id="screenTournament" class="hidden fade-in">
    <h3>מסך הטורניר</h3>

    <!-- טבלת קבוצות מורחבת: W, D, L, GF, GA, GD, PTS, Rank -->
    <h5>טבלת הקבוצות</h5>
    <table class="table table-bordered text-center" id="teamsTable">
      <thead class="table-light">
        <tr>
          <th>קבוצה</th>
          <th>צבע</th>
          <th>W</th>
          <th>D</th>
          <th>L</th>
          <th>GF</th>
          <th>GA</th>
          <th>+/-</th>
          <th>נקודות</th>
          <th>מיקום</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- מלך השערים -->
    <h5>מלך השערים</h5>
    <table class="table table-bordered table-sm" id="scorersTable">
      <thead class="table-light">
        <tr>
          <th>שחקן</th>
          <th>קבוצה</th>
          <th>שערים</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <hr/>
    <!-- בחירת המבקיעים: הצגת שחקני שתי הקבוצות הפעילות עם כפתורי +/– -->
    <h5 id="currentMatchTitle"></h5>
    <div class="row" id="activeTeamsPlayersContainer"></div>

    <div class="mt-2 mb-3">
      <p>
        <strong>תוצאה:</strong> 
        <span>קבוצה A: <span id="teamAGoalsLabel">0</span></span> |
        <span>קבוצה B: <span id="teamBGoalsLabel">0</span></span>
      </p>
      <button class="btn btn-success" id="submitMatchBtn">סיים משחק</button>
    </div>

    <hr/>
    <h5>גרף שערים כלליים (דוגמה)</h5>
    <canvas id="goalsChart" width="400" height="150"></canvas>

    <hr/>
    <h5>משחקים שהתקיימו</h5>
    <table class="table table-bordered" id="matchesTable">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>משחק</th>
          <th>תוצאה</th>
          <th>עולה</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- מסך שישי: סיום הטורניר -->
  <div id="screenEnd" class="hidden fade-in">
    <h2>הטורניר הסתיים</h2>
    <p>תודה רבה! אם תרצה להתחיל טורניר חדש, נא לרענן את הדף או חזור לראשית.</p>
  </div>
</div>

<!-- מודאל (Modal) של תיקו - לבחור מי המפסיד -->
<div class="modal fade" id="tieModal" tabindex="-1" aria-labelledby="tieModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <h5 id="tieModalLabel" class="mb-3">תיקו! בחר מי הפסידה בהגרלה</h5>
      <p id="tieModalTeams" class="fw-bold text-center"></p>
      <div class="d-grid gap-2">
        <button class="btn btn-warning" id="tieTeamAButton"></button>
        <button class="btn btn-warning" id="tieTeamBButton"></button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle + Popper -->
<script 
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>

<script>
// ---------------------------------------------------
//   SERVICE WORKER + PWA התקנה
// ---------------------------------------------------
let deferredPrompt = null;
const installBtn = document.getElementById("installBtn");

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
});

installBtn.addEventListener('click', async() => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      console.log('User accepted A2HS');
    } else {
      console.log('User dismissed A2HS');
    }
    deferredPrompt = null;
    installBtn.style.display = 'none';
});

// הפעלת ה-Tooltip של בוטסטראפ
document.addEventListener('DOMContentLoaded', () => {
  const tooltipTriggerList = [].slice.call(
    document.querySelectorAll('[data-bs-toggle="tooltip"]')
  );
  tooltipTriggerList.map((tooltipTriggerEl) => {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// ---------------------------------------------------
//  משתנים גלובליים למבנה האפליקציה
// ---------------------------------------------------
let numTeams = 3;          // מספר קבוצות
let playersPerTeam = 6;    // כמה שחקנים בכל קבוצה
let totalPlayers = 18;     // numTeams * playersPerTeam
let playersPool = [];      // מערך שמות השחקנים

// בכל קבוצה: { name, color, players:[], w, d, l, gf, ga, gd, points }
let teams = [];

// "המפסיד יוצא" – נוסיף מערך של 'activeTeamIndices' ומשתנה לwaitingTeams, 
// כדי לתמוך גם ב-4+ קבוצות
let activeTeams = [];   // נניח 2 על המגרש
let waitingTeams = [];  // השאר (numTeams - 2)
let matches = [];       // היסטוריית משחקים
let matchCount = 0;     // מונה משחקים
let tieState = null;    // מידע זמני אם קרה תיקו

// scorers = { "שחקן": { goals, teamName } }
let scorers = {};

// הגרף (Chart.js)
let goalsChart = null;
let chartData = {
  labels: [],
  datasets: [{
    label: 'סך שערים במשחק',
    data: [],
    borderColor: 'blue',
    backgroundColor: 'rgba(54,162,235,0.2)'
  }]
};

// ---------------------------------------------------
//  שלב 1: הגדרת טורניר (מספר קבוצות, וכו')
// ---------------------------------------------------
const screenConfig = document.getElementById("screenConfig");
const startSetupBtn = document.getElementById("startSetupBtn");
startSetupBtn.addEventListener("click", () => {
  numTeams = parseInt(document.getElementById("numTeamsInput").value) || 2;
  playersPerTeam = parseInt(document.getElementById("playersPerTeamInput").value) || 1;
  if (numTeams < 2) numTeams = 2;
  if (playersPerTeam < 1) playersPerTeam = 1;
  totalPlayers = numTeams * playersPerTeam;
  // מעבר למסך 'screenPlayers'
  showScreen("screenPlayers");
  document.getElementById("totalPlayersSpan").textContent = totalPlayers;
});

// ---------------------------------------------------
//  שלב 2: הזנת שמות שחקנים
// ---------------------------------------------------
const screenPlayers = document.getElementById("screenPlayers");
const goToDefineTeamsBtn = document.getElementById("goToDefineTeamsBtn");
goToDefineTeamsBtn.addEventListener("click", () => {
  const rawText = document.getElementById("playersInput").value.trim();
  if (!rawText) {
    alert("לא הוזנו שמות!");
    return;
  }
  let names = rawText.split(/[\n,]+/).map(s => s.trim()).filter(s => s);
  if (names.length !== totalPlayers) {
    alert(`צריך להזין בדיוק ${totalPlayers} שמות!`);
    return;
  }
  playersPool = names;
  // מעבר למסך הגדרת הקבוצות
  setupTeamsArray(); // נכין את 'teams'
  renderTeamsDefinition();
  showScreen("screenDefineTeams");
});

// ---------------------------------------------------
//  הכנת מערך teams
//   (ברירת מחדל: "קבוצה 1" צבע אקראי וכו') 
// ---------------------------------------------------
function setupTeamsArray() {
  teams = [];
  for (let i = 0; i < numTeams; i++) {
    teams.push({
      name: `קבוצה ${i+1}`, 
      color: getRandomColor(),
      players: [],
      w:0, d:0, l:0,
      gf:0, ga:0, gd:0,
      points:0
    });
  }
}
// פונקציה לעזור ליצור צבע אקראי
function getRandomColor() {
  const letters = '0123456789ABCDEF';
  let color = '#';
  for(let i=0;i<6;i++){
    color += letters[Math.floor(Math.random()*16)];
  }
  return color;
}

// ---------------------------------------------------
//  שלב 3: הגדרת הקבוצות (שם, צבע). 
//  יש ברירת מחדל, אך אפשר לערוך
// ---------------------------------------------------
const screenDefineTeams = document.getElementById("screenDefineTeams");
const teamsDefinitionDiv = document.getElementById("teamsDefinition");
const teamsDefinitionDoneBtn = document.getElementById("teamsDefinitionDoneBtn");

function renderTeamsDefinition() {
  teamsDefinitionDiv.innerHTML = "";
  teams.forEach((t,idx) => {
    let div = document.createElement("div");
    div.className = "border rounded p-2 mb-2";
    div.innerHTML = `
      <label>שם קבוצה #${idx+1}:</label>
      <input type="text" class="form-control mb-2" value="${t.name}">
      <label>צבע קבוצה #${idx+1}:</label>
      <input type="color" class="form-control mb-2" value="${t.color}">
    `;
    let inputName = div.querySelector('input[type="text"]');
    let inputColor= div.querySelector('input[type="color"]');
    inputName.addEventListener("input", () => {
      teams[idx].name = inputName.value || `קבוצה ${idx+1}`;
    });
    inputColor.addEventListener("input", () => {
      teams[idx].color = inputColor.value;
    });

    teamsDefinitionDiv.appendChild(div);
  });
}

teamsDefinitionDoneBtn.addEventListener("click", () => {
  // מעבר למסך חלוקת שחקנים
  renderPlayersAssignment();
  showScreen("screenAssign");
});

// ---------------------------------------------------
//  שלב 4: חלוקת השחקנים לקבוצות
// ---------------------------------------------------
const screenAssign = document.getElementById("screenAssign");
const playersAssignContainer = document.getElementById("playersAssignContainer");
const finishAssignBtn = document.getElementById("finishAssignBtn");

function renderPlayersAssignment() {
  // איפוס players בכל קבוצה
  teams.forEach(t => t.players = []);
  playersAssignContainer.innerHTML = "";
  playersPool.forEach(playerName => {
    let row = document.createElement("div");
    row.className = "player-row";

    let spanN = document.createElement("span");
    spanN.textContent = playerName;

    let selectT = document.createElement("select");
    selectT.className = "form-select w-50";
    let optNone = new Option("לא מוקצה","none",true,true);
    selectT.add(optNone);

    teams.forEach((tt, i) => {
      let opt = new Option(tt.name, i);
      selectT.add(opt);
    });

    selectT.addEventListener("change", () => {
      // הסר מהקודם
      teams.forEach(tt => {
        let idx = tt.players.indexOf(playerName);
        if (idx!==-1) tt.players.splice(idx,1);
      });
      // הוסף לחדש
      if (selectT.value!=="none") {
        teams[+selectT.value].players.push(playerName);
      }
    });

    row.appendChild(spanN);
    row.appendChild(selectT);
    playersAssignContainer.appendChild(row);
  });
}

finishAssignBtn.addEventListener("click", () => {
  // בדוק שכל הקבוצות מלאות בדיוק playersPerTeam
  // ואם יש שחקנים לא מוקצים
  for (let i=0; i<teams.length; i++) {
    if (teams[i].players.length !== playersPerTeam) {
      alert(`חובה לחלק בדיוק ${playersPerTeam} שחקנים בכל קבוצה!
קבוצה ${teams[i].name} כוללת כעת ${teams[i].players.length}.`);
      return;
    }
  }
  // מעבר למסך הטורניר
  prepareTournament();
  showScreen("screenTournament");
  updateTeamsTable();
  updateScorersTable();
  renderCurrentMatch();
  initChart();
});

// ---------------------------------------------------
//  שלב 5: הטורניר
//    - "המפסיד יוצא": בהתחלה ניקח 2 קבוצות ל-active, היתר ב-waiting
// ---------------------------------------------------
function prepareTournament() {
  matches = [];
  matchCount = 0;
  scorers = {};
  // כל הסטטיסטיקות 0
  teams.forEach(t => {
    t.w=0; t.d=0; t.l=0;
    t.gf=0; t.ga=0; t.gd=0;
    t.points=0;
  });
  // active
  activeTeams = [0,1];
  waitingTeams = [];
  for(let i=2;i<teams.length;i++){
    waitingTeams.push(i);
  }
}

// רענון תצוגת המשחק הנוכחי
function renderCurrentMatch() {
  let tAidx = activeTeams[0], tBidx = activeTeams[1];
  let tA = teams[tAidx], tB = teams[tBidx];
  document.getElementById("currentMatchTitle").textContent =
    `(${matchCount+1}) ${tA.name} נגד ${tB.name}`;

  // יצירת 2 עמודות, בכל עמודה רשימת שחקני הקבוצה עם כפתורי +/–
  let container = document.getElementById("activeTeamsPlayersContainer");
  container.innerHTML = `
    <div class="col-md-6" id="teamAPlayersCol"></div>
    <div class="col-md-6" id="teamBPlayersCol"></div>
  `;
  let colA = document.getElementById("teamAPlayersCol");
  let colB = document.getElementById("teamBPlayersCol");

  colA.innerHTML = `<h6>${tA.name}</h6>`;
  tA.players.forEach(playerName => {
    let row = document.createElement("div");
    row.className = "player-row";
    row.innerHTML = `
      <span>${playerName}</span>
      <div class="player-controls">
        <button class="btn btn-sm btn-light" data-action="minus">–</button>
        <span class="mx-1" data-score="0">0</span>
        <button class="btn btn-sm btn-light" data-action="plus">+</button>
      </div>
    `;
    let spanScore = row.querySelector('[data-score]');
    row.querySelectorAll('button').forEach(btn => {
      btn.addEventListener("click",(e)=>{
        let act = btn.getAttribute("data-action");
        let val = parseInt(spanScore.textContent) || 0;
        if(act==="plus") val++;
        if(act==="minus" && val>0) val--;
        spanScore.textContent = val;
        updateGoalsLabels();
      });
    });
    colA.appendChild(row);
  });

  colB.innerHTML = `<h6>${tB.name}</h6>`;
  tB.players.forEach(playerName => {
    let row = document.createElement("div");
    row.className = "player-row";
    row.innerHTML = `
      <span>${playerName}</span>
      <div class="player-controls">
        <button class="btn btn-sm btn-light" data-action="minus">–</button>
        <span class="mx-1" data-score="0">0</span>
        <button class="btn btn-sm btn-light" data-action="plus">+</button>
      </div>
    `;
    let spanScore = row.querySelector('[data-score]');
    row.querySelectorAll('button').forEach(btn => {
      btn.addEventListener("click",(e)=>{
        let act = btn.getAttribute("data-action");
        let val = parseInt(spanScore.textContent) || 0;
        if(act==="plus") val++;
        if(act==="minus" && val>0) val--;
        spanScore.textContent = val;
        updateGoalsLabels();
      });
    });
    colB.appendChild(row);
  });
  updateGoalsLabels();
}

function updateGoalsLabels(){
  // סוכמים את השערים בקולונה A, וקולונה B
  let colA = document.getElementById("teamAPlayersCol");
  let colB = document.getElementById("teamBPlayersCol");
  let sumA=0, sumB=0;
  colA.querySelectorAll('[data-score]').forEach(sp=>{
    sumA += parseInt(sp.textContent) || 0;
  });
  colB.querySelectorAll('[data-score]').forEach(sp=>{
    sumB += parseInt(sp.textContent) || 0;
  });
  document.getElementById("teamAGoalsLabel").textContent = sumA;
  document.getElementById("teamBGoalsLabel").textContent = sumB;
}

// ---------------------------------------------------
//  סיום משחק: עדכון תוצאה, "המפסיד יוצא"
// ---------------------------------------------------
document.getElementById("submitMatchBtn").addEventListener("click", () => {
  finishMatch();
});

function finishMatch() {
  let tAidx = activeTeams[0], tBidx = activeTeams[1];
  let tA = teams[tAidx], tB = teams[tBidx];
  let sumA = parseInt(document.getElementById("teamAGoalsLabel").textContent) || 0;
  let sumB = parseInt(document.getElementById("teamBGoalsLabel").textContent) || 0;

  // עדכון מלך השערים
  // נלך על colA ו-colB, לכל שחקן, נשווה data-score
  let colA = document.getElementById("teamAPlayersCol");
  let colB = document.getElementById("teamBPlayersCol");

  colA.querySelectorAll('.player-row').forEach(r => {
    let name = r.querySelector('span').textContent.trim();
    let sc = parseInt(r.querySelector('[data-score]').textContent) || 0;
    addGoalsToScorer(name, tA.name, sc);
  });
  colB.querySelectorAll('.player-row').forEach(r => {
    let name = r.querySelector('span').textContent.trim();
    let sc = parseInt(r.querySelector('[data-score]').textContent) || 0;
    addGoalsToScorer(name, tB.name, sc);
  });

  // עדכון סטטיסטיקות לקבוצות
  matchCount++;
  tA.gf += sumA; tA.ga += sumB; tA.gd = tA.gf - tA.ga;
  tB.gf += sumB; tB.ga += sumA; tB.gd = tB.gf - tB.ga;

  let loserIndex = null;
  let winnerIndex = null;
  if(sumA>sumB) {
    tA.w++; tB.l++;
    tA.points += 3;
    winnerIndex = tAidx;
    loserIndex = tBidx;
  }
  else if(sumB>sumA) {
    tB.w++; tA.l++;
    tB.points += 3;
    winnerIndex = tBidx;
    loserIndex = tAidx;
  }
  else {
    // תיקו
    tA.d++; tB.d++;
    tA.points++; tB.points++;
    // נפתח מודאל בחירת מפסידה
    tieState = {
      sumA, sumB,
      tAindex: tAidx, 
      tBindex: tBidx
    };
    showTieModal();
    return; // נפסיק כאן, נמשיך אחרי בחירת מפסידה
  }

  recordMatch(winnerIndex, loserIndex, sumA, sumB);
}

// רישום המשחק בהיסטוריה והחלפת המפסידה בקבוצה ממתינה (אם יש)
function recordMatch(winnerIndex, loserIndex, goalsA, goalsB, tieWinnerIdx=null) {
  let matchObj = {
    matchNumber: matchCount,
    teamA: activeTeams[0],
    teamB: activeTeams[1],
    goalsA,
    goalsB,
    winner: winnerIndex,
    tieWinner: tieWinnerIdx, // למקרה של תיקו
  };
  matches.push(matchObj);

  // המפסידה יוצאת, נכנסת אחת מ-waitingTeams (אם יש)
  if(loserIndex!==null) {
    if(waitingTeams.length>0) {
      let wTeam = waitingTeams.shift(); // הבאה בתור
      if(loserIndex===activeTeams[0]) {
        activeTeams[0] = wTeam;
      } else {
        activeTeams[1] = wTeam;
      }
      waitingTeams.push(loserIndex);
    }
  }

  updateTeamsTable();
  updateScorersTable();
  updateMatchesTable();
  updateChartData(goalsA+goalsB);
  renderCurrentMatch();
}

// ---------------------------------------------------
//  טיפול בתיקו: מודאל בחירת מפסידה
// ---------------------------------------------------
let tieModal = new bootstrap.Modal(document.getElementById("tieModal"));
let tieTeamAButton = document.getElementById("tieTeamAButton");
let tieTeamBButton = document.getElementById("tieTeamBButton");
let tieModalTeams = document.getElementById("tieModalTeams");

function showTieModal() {
  let tAidx = tieState.tAindex;
  let tBidx = tieState.tBindex;
  let tA = teams[tAidx], tB = teams[tBidx];
  tieModalTeams.textContent = `${tA.name} מול ${tB.name}`;
  tieTeamAButton.textContent = `מפסידה: ${tA.name}`;
  tieTeamBButton.textContent = `מפסידה: ${tB.name}`;

  tieModal.show();
}

tieTeamAButton.addEventListener("click",() => {
  tieModal.hide();
  let loserIndex = tieState.tAindex;
  let winnerIndex = tieState.tBindex;
  recordMatch(winnerIndex, loserIndex, tieState.sumA, tieState.sumB, winnerIndex);
  tieState=null;
});
tieTeamBButton.addEventListener("click",() => {
  tieModal.hide();
  let loserIndex = tieState.tBindex;
  let winnerIndex = tieState.tAindex;
  recordMatch(winnerIndex, loserIndex, tieState.sumA, tieState.sumB, winnerIndex);
  tieState=null;
});

// ---------------------------------------------------
//  עדכון טבלת קבוצות מורחבת (W, D, L, GF, GA, GD, pts, rank)
// ---------------------------------------------------
function updateTeamsTable() {
  // קודם למיין לפי נקודות, אחר כך הפרש שערים, וכו'
  // אבל לא נשנה את המערך הקבוצות עצמו (או שכן), 
  // נייצר עותק ממוין
  let sorted = teams.map((t,idx)=>({...t, index:idx}));
  // מיון: points יורד, GD יורד, GF יורד, index עולה
  sorted.sort((a,b)=>{
    if(b.points!==a.points) return b.points - a.points;
    if(b.gd!==a.gd) return b.gd - a.gd;
    // אפשר עוד breaker, אבל זה מספיק להדגמה
    return a.index - b.index;
  });
  // קביעת "מיקום" בטבלה
  sorted.forEach((t,i)=>{
    t.rank = i+1;
  });

  let tbody = document.querySelector("#teamsTable tbody");
  tbody.innerHTML="";
  sorted.forEach(t=>{
    let tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${t.name}</td>
      <td>
        ${t.color}
        <span style="display:inline-block;width:12px;height:12px;background:${t.color};margin-right:5px;"></span>
      </td>
      <td>${t.w}</td>
      <td>${t.d}</td>
      <td>${t.l}</td>
      <td>${t.gf}</td>
      <td>${t.ga}</td>
      <td>${t.gd}</td>
      <td>${t.points}</td>
      <td>${t.rank}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------------------------------------------------
//  עדכון טבלת מלך השערים
// ---------------------------------------------------
function addGoalsToScorer(name, teamName, goals) {
  if(!scorers[name]) {
    scorers[name] = { goals: 0, team: teamName };
  }
  scorers[name].goals += goals;
  scorers[name].team = teamName; // עדכון team למקרה שעבר קבוצה? (נדיר)
}
function updateScorersTable() {
  let arr = Object.keys(scorers).map(k => ({
    name:k, 
    goals: scorers[k].goals, 
    team: scorers[k].team
  }));
  arr.sort((a,b)=>b.goals - a.goals);
  let tb = document.querySelector("#scorersTable tbody");
  tb.innerHTML="";
  arr.forEach(s=>{
    let tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${s.name}</td>
      <td>${s.team}</td>
      <td>${s.goals}</td>
    `;
    tb.appendChild(tr);
  });
}

// ---------------------------------------------------
// היסטוריית משחקים: #, מי שיחק, תוצאה, עולה
// ---------------------------------------------------
function updateMatchesTable() {
  let tb = document.querySelector("#matchesTable tbody");
  tb.innerHTML="";
  matches.forEach(m=>{
    let tA = teams[m.teamA];
    let tB = teams[m.teamB];
    let w = (m.winner!==null) ? teams[m.winner].name : null;
    let tieW = (m.tieWinner!==undefined && m.tieWinner!==null) 
      ? teams[m.tieWinner].name : null;

    let row = document.createElement("tr");
    row.innerHTML = `
      <td>${m.matchNumber}</td>
      <td>${tA.name} - ${tB.name}</td>
      <td>${m.goalsA} : ${m.goalsB}</td>
      <td>${
        w ? w : (tieW ? "תיקו => " + tieW : "")
      }</td>
    `;
    tb.appendChild(row);
  });
}

// ---------------------------------------------------
//  גרף Chart.js של סך השערים בכל משחק
// ---------------------------------------------------
function initChart(){
  let ctx = document.getElementById("goalsChart");
  goalsChart = new Chart(ctx, {
    type:'line',
    data: chartData,
    options: {
      responsive:true,
      plugins: {
        title: {
          display:true,
          text:'כמות שערים בכל משחק'
        }
      }
    }
  });
  chartData.labels=[]; 
  chartData.datasets[0].data=[];
  goalsChart.update();
}

function updateChartData(totalGoals){
  chartData.labels.push("משחק " + matchCount);
  chartData.datasets[0].data.push(totalGoals);
  goalsChart.update();
}

// ---------------------------------------------------
//  כפתור סיום טורניר (עובר למסך הסיום)
// ---------------------------------------------------
document.getElementById("endTournamentBtn").addEventListener("click", () => {
  showScreen("screenEnd");
});

// ---------------------------------------------------
//  הצגת מסכים
// ---------------------------------------------------
function showScreen(screenId) {
  const screens = [
    "screenConfig",
    "screenPlayers",
    "screenDefineTeams",
    "screenAssign",
    "screenTournament",
    "screenEnd"
  ];
  screens.forEach(s => {
    document.getElementById(s).classList.add("hidden");
  });
  document.getElementById(screenId).classList.remove("hidden");
}

// ---------------------------------------------------
//  טעינה ראשונית
// ---------------------------------------------------
window.addEventListener("load", () => {
  // התחל במסך הגדרת טורניר
  showScreen("screenConfig");
});
</script>

</body>
</html>
